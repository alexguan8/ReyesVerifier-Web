<!doctype html>
<html class="no-js" lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>srtdash - ICO Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='images/icon/favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/font-awesome.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/themify-icons.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/metisMenu.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/owl.carousel.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/slicknav.min.css') }}">
    <!-- amchart css -->
    <link rel="stylesheet" href="https://www.amcharts.com/lib/3/plugins/export/export.css" type="text/css" media="all" />
    <!-- others css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/typography.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/default-css.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}">
    <!-- modernizr css -->
    <script src="{{ url_for('static', filename='js/vendor/modernizr-2.8.3.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/display.js') }}"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <!-- MY CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/misc.css') }}">
</head>

<body>
    <!--[if lt IE 8]>
      <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
      <![endif]-->
    <!-- preloader area start -->
    <div id="preloader">
        <div class="loader"></div>
    </div>
    <!-- preloader area end -->
    <!-- page container area start -->
    <div class="page-container">
        <!-- sidebar menu area start -->
        <div class="sidebar-menu">
            <div class="sidebar-header">
                <div class="">
                    <a href=""><img src="{{ url_for('static', filename='images/icon/logo.png') }}" alt="logo"></a>
                </div>
            </div>
            <div class="main-menu">
                <div class="menu-inner">
                    <nav>
                        <ul class="metismenu" id="menu">
                            <li class="active">
                                <a href="javascript:void(0)" aria-expanded="true"><i class="ti-dashboard"></i></a>
                                <ul class="collapse">
                                    <li class="active"><a href="/">Verify Files</a></li>
                                    <li class=""><a href="twitter.html">Statistics</a></li>
                                </ul>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
        <!-- sidebar menu area end -->
        <!-- main content area start -->
        <div class="main-content">
            <!-- header area start -->
            <div class="header-area">
                <div class="row align-items-center">
                    <!-- nav and search button -->
                    <div class="col-md-6 col-sm-8 clearfix">
                        <div class="nav-btn pull-left">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                    <!-- profile info & task notification -->
                    <div class="col-md-6 col-sm-4 clearfix">
                    </div>
                </div>
            </div>
            <!-- header area end -->
            <!-- page title area start -->
            <div class="page-title-area">
                <div class="row align-items-center">
                    <div class="col-sm-6">
                        <div class="breadcrumbs-area clearfix">
                            <h4 class="page-title pull-left">Dashboard</h4>
                            <ul class="breadcrumbs pull-left">
                                <li><a href="/">Home</a></li>
                                <li><span>Dashboard</span></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-sm-6 clearfix">
                    </div>
                </div>
            </div>
            <!-- page title area end -->
            <div class="main-content-inner">
                <br>
                <br>
                <h1>SELECT A CSV FILE TO VERIFY</h1>
                <form id="fileForm" action="/verify" method="POST" enctype="multipart/form-data">
                    <!-- File selection box -->
                    <div class="input-group mb-3">
                        <!-- Dropdown menu -->
                        <button id="selected" class="btn btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">File Type</button>
                        <input type="hidden" name="selectedHidden" id="selectedHidden" value="">
                        <div class="dropdown-menu" name="types">
                            <a class="dropdown-item" href="#">Inventory</a>
                            <a class="dropdown-item" href="#">Sale</a>
                            <a class="dropdown-item" href="#">Payroll</a>
                            <a class="dropdown-item" href="#">Static Percentages</a>
                        </div>
                        <div class="custom-file">
                            <input type="file" accept=".csv" class="custom-file-input" id="csvFileInput" name="csvFileInput" aria-describedby="inputGroupFileAddon01">
                            <label id="file_input_label" class="custom-file-label" for="csvFileInput">Choose File</label>
                        </div>
                        <div class="input-group-append">
                            <!-- Passes in the request object to upload() -->
                            <button class="btn btn-primary" type="submit" id="upload_btn" data-toggle="" aria-haspopup="" aria-expanded="false">VERIFY</button>
                            <button class="btn btn-primary d-none" id="loading_btn" type="button" disabled>
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                Uploading...
                            </button>
                        </div>
                    </div>
                </form>

                <button type="button" id="cancel_btn" class="btn btn-secondary d-none">Cancel upload</button>

                <!-- The file upload progress bar -->
                <div id="progress_wrapper" class="d-none">
                    <label id="progress_status"></label>
                    <div class="progress mb-3">
                        <div id="progress" class="progress-bar" role="progressbar" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>

                <div id="alert_wrapper"></div>

                <p> Select a file to verify, then choose the file type out of the dropdown menu. Press verify, and we'll handle everything else for you! </p>

                {% with messages = get_flashed_messages() %} {% if messages %}
                <ul class=flashes>
                    {% for message in messages %}
                    <p><strong>{{ message }}</strong></p>
                    {% endfor %}
                </ul>
                {% endif %} {% endwith %} {% if output %}
                <p id="output" name="output"><strong>{{ output }}!</strong></p>
                {% endif %}

            </div>
        </div>

        <!-- main content area end -->
        <!-- footer area start-->
        <footer>
            <div class="footer-area">
                <p>Created by Alex Guan for Reyes Beverage Group.</p>
            </div>
        </footer>
        <!-- footer area end-->
    </div>
    <!-- page container area end -->
    <script>
        //Jquery stuff
        $('#csvFileInput').on('change', function() {
            //get the file name
            var pathwithfilename = $(this).val();
            var fileName = pathwithfilename.substring(12);
            //replace the "Choose a file" label
            $(this).next('.custom-file-label').html(fileName);
        })

        $('.dropdown-menu a').click(function() {
            $('#selected').text($(this).text());
            $('input#selectedHidden').val($(this).text());
        });

        $('#fileForm').submit(function(event) {
            var formId = $(this).attr('id');
            upload('{{ request.url }}');

            event.preventDefault();

            //delay so that the python script has time to run
            setTimeout(function() {
                $('#fileForm').submit();
            }, 5000);

        });

        // Get a reference to the progress bar, wrapper & status label
        var progress = document.getElementById("progress");
        var progress_wrapper = document.getElementById("progress_wrapper");
        var progress_status = document.getElementById("progress_status");

        // Get a reference to the 3 buttons
        var upload_btn = document.getElementById("upload_btn");
        var loading_btn = document.getElementById("loading_btn");
        var cancel_btn = document.getElementById("cancel_btn");

        // Get a reference to the alert wrapper
        var alert_wrapper = document.getElementById("alert_wrapper");

        // Get a reference to the file input element & input label 
        var input = document.getElementById("csvFileInput");
        var file_input_label = document.getElementById("file_input_label");

        // Function to show alerts
        function show_alert(message, alert) {

            alert_wrapper.innerHTML = `
                    <div id="alert" class="alert alert-${alert} alert-dismissible fade show" role="alert">
                        <span>${message}</span>
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                `

        }

        // Function to upload file
        function upload(url) {
            // Reject if the file input is empty & throw alert
            if (!input.value) {

                show_alert("No file selected", "warning")

                return;

            }

            // Create a new FormData instance
            var data = new FormData();

            // Create a XMLHTTPRequest instance
            var request = new XMLHttpRequest();

            // Set the response type
            request.responseType = "json";

            // Clear any existing alerts
            alert_wrapper.innerHTML = "";

            // Disable the input during upload
            input.disabled = true;

            // Hide the upload button
            upload_btn.classList.add("d-none");

            // Show the loading button
            loading_btn.classList.remove("d-none");

            // Show the cancel button
            cancel_btn.classList.remove("d-none");

            // Show the progress bar
            progress_wrapper.classList.remove("d-none");

            // Get a reference to the file
            var file = input.files[0];

            // Get a reference to the filename
            var filename = file.name;

            // Get a reference to the filesize & set a cookie
            var filesize = file.size;
            document.cookie = `filesize=${filesize}`;

            // Append the file to the FormData instance
            data.append("file", file);

            // request progress handler
            request.upload.addEventListener("progress", function(e) {

                // Get the loaded amount and total filesize (bytes)
                var loaded = e.loaded;
                var total = e.total

                // Calculate percent uploaded
                var percent_complete = (loaded / total) * 100;

                // Update the progress text and progress bar
                progress.setAttribute("style", `width: ${Math.floor(percent_complete)}%`);
                progress_status.innerText = `${Math.floor(percent_complete)}% uploaded`;

            })

            // request load handler (transfer complete)
            request.addEventListener("load", function(e) {

                if (request.status == 200) {

                    show_alert(`${request.response.message}`, "success");

                } else {

                    show_alert(`Error uploading file`, "danger");

                }

                reset();

            });

            // request error handler
            request.addEventListener("error", function(e) {

                reset();

                show_alert(`Error uploading file`, "warning");

            });

            // request abort handler
            request.addEventListener("abort", function(e) {

                reset();
                resetInput();

                show_alert(`Upload cancelled`, "primary");

            });

            // Open and send the request
            request.open("post", url);
            request.send(data);

            cancel_btn.addEventListener("click", function() {

                request.abort();
                reset();
                resetInput();

            })

        }

        function resetInput() {
            input.value = null;
        }

        // Function to reset the page
        function reset() {

            // Hide the cancel button
            cancel_btn.classList.add("d-none");

            // Reset the input element
            input.disabled = false;

            // Show the upload button
            upload_btn.classList.remove("d-none");

            // Hide the loading button
            loading_btn.classList.add("d-none");

            // Hide the progress bar
            progress_wrapper.classList.add("d-none");

            // Reset the progress bar state
            progress.setAttribute("style", `width: 0%`);

            // Reset the input placeholder
            file_input_label.innerText = "Select file";

        }
    </script>

    <!-- jquery latest version -->
    <script src="{{ url_for('static', filename='js/vendor/jquery-2.2.4.min.js') }}"></script>
    <!-- bootstrap 4 js -->
    <script src="{{ url_for('static', filename='js/popper.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/owl.carousel.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/metisMenu.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.slimscroll.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.slicknav.min.js') }}"></script>
    <!-- start chart js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js"></script>
    <!-- start highcharts js -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <!-- start zingchart js -->
    <script src="https://cdn.zingchart.com/zingchart.min.js"></script>
    <script>
        zingchart.MODULESDIR = "https://cdn.zingchart.com/modules/";
        ZC.LICENSE = ["569d52cefae586f634c54f86dc99e6a9", "ee6b7db5b51705a13dc2339db3edaf6d"];
    </script>
    <!-- start amchart js -->
    <script src="https://www.amcharts.com/lib/3/amcharts.js"></script>
    <script src="https://www.amcharts.com/lib/3/serial.js"></script>
    <script src="https://www.amcharts.com/lib/3/plugins/export/export.min.js"></script>
    <script src="https://www.amcharts.com/lib/3/themes/light.js"></script>
    <!-- all line chart activation -->
    <script src="{{ url_for('static', filename='js/customCharts.js') }}"></script>
    <!-- all bar chart activation -->
    <script src="{{ url_for('static', filename='js/bar-chart.js') }}"></script>
    <!-- all pie chart -->
    <script src="{{ url_for('static', filename='js/pie-chart.js') }}"></script>
    <!-- others plugins -->
    <script src="{{ url_for('static', filename='js/plugins.js') }}"></script>
    <script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
</body>

</html>